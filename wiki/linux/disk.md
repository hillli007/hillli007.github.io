---
title: 磁盘
date: 2018-10-15 00:03:17
tags:
---

## 硬件

- 磁盘是由一系列盘片组成的圆柱体，每个盘片都有上下面两个对应的磁头
- 每个盘面上的同心圆就是一个磁道(Track)，一个磁道上等分的一小段弧形就是磁盘基本单位Sector
- 从外到内，从上到下（外圈转速高）

* Cylinder: 柱面所有半径相同的磁道的组合，是圆柱体的一个侧面
* Heads: 磁头数，等于盘片数的两倍
* Track: 柱面中同心圆为一条条磁道
* Sector: 扇区，基本单位，一般为512Byte,现在大容量机械硬盘有4096Byte的,SSD是对外是512Byte，但不是真实存在的，用于模拟机械硬盘，系统只认块。

* Block/Cluster(win)(块/簇)：
   磁盘块/簇（虚拟出来的）, 块是操作系统中最小的逻辑存储单位。操作系统与磁盘打交道的最小单位是磁盘块。
通俗的来讲，在Windows下如NTFS等文件系统中叫做簇；在Linux下如Ext4等文件系统中叫做块（block）。
每个簇或者块可以包括2、4、8、16、32、64…2的n次方个扇区。

> 为什么存在磁盘块？
> 读取方便：由于扇区的数量比较小，数目众多在寻址时比较困难，所以操作系统就将相邻的扇区组合在一起，形成一个块，再对块进行整体的操作。
> 分离对底层的依赖：操作系统忽略对底层物理存储结构的设计。通过虚拟出来磁盘块的概念，在系统中认为块是最小的单位。

~~~
# 查看块大小
getconf PAGESIZE
~~~

## 分区

### 分区类型

- 主分区: 引导分区，最多可能创建4个
- 扩展分区: 除了主分区外，剩余的磁盘空间就是扩展分区了，扩展分区是一个概念，实际上是看不到的。
- 逻辑分区: 在扩展分区上面，可以创建多个逻辑分区。

磁盘第一个扇区就是存储MBR，就算是GPT也要有，这是BIOS认识磁盘的根据,,
分区本质是改分区表，

MBR分区表:
- 第一个扇区为分区表, 所谓的“分区”只是针对那个64bytes 的分区表进行设置而已
- 扇区(512B): 446B启动程序 + 64B分区表 + 2B结束标志(aa55)
- 64B分区表可划分四个主分区，每个分区用16b表示

~~~
sudo dd if=/dev/sdc of=mbr bs=512 count=1
hexdump -C mbr
~~~

GPT分区:

LBA寻址方式定位的是扇区不是块

* LBA0: 保护性MBR，在GPT分区表的最开头，处于兼容性考虑仍然存储了一份传统的MBR
* LBA1：主要GPT头部：主要GPT头部位于1号扇区，会定义分区表的起始位置，结束位置，分区表项个数；
* LBA2 ~ LBA33：分区表位于GPT磁盘的2-33号扇区，一共占用32个扇区，能够容纳128个分区表项。每个分区表项大小为128字节。因为每个分区表项管理一个分区，所以GPT磁盘可以创建128个分区。
* LBA34 ~ LBA-34: GPT分区区域就是用户使用的分区，也是用户进行数据存储的区域。分区区域的起始地址和结束地址由GPT头定义。
* LBA-33 ~ LBA-2：分区表备份
* LBA-1：GPT头备份

### 设备文件

linuix下一切皆文件，常见的设备类型包括块设备和字符设备，磁盘就算典型的块设备，

字符设备: 是一种按字节来访问的设备，字符驱动则负责驱动字符设备，这样的驱动通常实现open、close、read和write系统调用。例如：串口、Led、按键等。
块设备: 将信息存储在固定大小的块中，每个块都有自己的地址，还可以在设备的任意位置读取一定长度的数据


## 系统引导和启动

### Legacy

常见bootloader

grub引导流程:

1. BIOS将控制权交给硬盘的主引导区，即MBR。
2. MBR中的bootloader(stage1)通过内置的地址加载stage1_5
3. bootloader通过stage1_5的内容，将分区中的stage2加载
4. stage2此时就可以在文件系统中将grub.conf文件加载，让用户看到选项界面。

引导基本知识

grub安装在磁盘

grub安装在分区

启动到grub菜单，按c进入命令行界面，这里可以手动配置

### UEFI

 -> 集成在主板，直接去跑efi来启动系统，所以都不用BootLoader了
 -> 遍历设备, 查找带efi分区的设备
 -> 查找esp(或者直接在fat分区也行)

efi开发:

https://blog.csdn.net/xiaopangzi313/article/details/89578619
https://blog.csdn.net/xiaopangzi313/article/details/89596652

## samba

需安装: samba samba-common
samba用户必须是Linux用户，通过<code>smbpasswd -a user</code>添加samba用户, user必须是**linux用户**

配置:

~~~
[item]
path = /path/to/dir
writable = yes
write list = user
~~~